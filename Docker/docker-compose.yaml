name: coghri_faces

services:
  eut_face_detection:
    container_name: "eut_face_detection"
    network_mode: host 
    ipc: host
    shm_size: 1gb
    runtime: ${DOCKER_RUNTIME:-runc}
    image: ${BUILT_IMAGE}
    privileged: true
    depends_on:
      - mongodb_faces_service
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ~/.xauth_docker/share/:/tmp/xauth/
      - ./.vscode:/workspace/.vscode
      - ../face_detection:/workspace/src/face_detection
      - ../face_recognition:/workspace/src/face_recognition
      - ../gaze_estimation:/workspace/src/gaze_estimation
      - ../visual_speech_activity:/workspace/src/visual_speech_activity
      - ./logs:/workspace/log
      # Cyclone DDS configuration for TiagoPro WiFi
      - ./cyclonedds_wifi.xml:/etc/cyclonedds.xml:ro

    tty: true
    stdin_open: true
    environment:
      - CYCLONEDDS_URI=file:///etc/cyclonedds.xml
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-0}  
      - RMW_IMPLEMENTATION=${RMW_IMPLEMENTATION:-rmw_fastdds_cpp}  
      - PACKAGE_NAME=face_detection
      - NVIDIA_VISIBLE_DEVICES=all 
      - DISPLAY=$DISPLAY
      - QT_X11_NO_MITSHM=1
      - XAUTHORITY=/tmp/xauth/.docker.xauth     
    devices:
      - /dev/dri:/dev/dri
      - /dev/snd:/dev/snd
    command: bash -c "source /workspace/install/setup.bash && ros2 launch face_detection face_detection.launch.py compressed_topic:=${IMG_RAW_TOPIC:-/camera/image_raw/compressed}" #ros4hri_with_id:=true
    entrypoint: ["/entrypoint.sh"]
    stop_signal: SIGINT
    stop_grace_period: 30s
  
  eut_face_recognition:
    container_name: "eut_face_recognition"
    network_mode: host 
    ipc: host
    shm_size: 1gb
    runtime: ${DOCKER_RUNTIME:-runc}
    image: ${BUILT_IMAGE}
    privileged: true
    depends_on:
      - mongodb_faces_service
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ~/.xauth_docker/share/:/tmp/xauth/
      - ./.vscode:/workspace/.vscode
      - ../face_detection:/workspace/src/face_detection
      - ../face_recognition:/workspace/src/face_recognition
      - ../gaze_estimation:/workspace/src/gaze_estimation
      - ../visual_speech_activity:/workspace/src/visual_speech_activity
      # Cyclone DDS configuration for TiagoPro WiFi
      - ./cyclonedds_wifi.xml:/etc/cyclonedds.xml:ro
      - ./logs:/workspace/log
      
    tty: true
    stdin_open: true
    environment:
      - CYCLONEDDS_URI=file:///etc/cyclonedds.xml
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-0}  
      - RMW_IMPLEMENTATION=${RMW_IMPLEMENTATION:-rmw_fastdds_cpp} 
      - PACKAGE_NAME=face_recognition
      - NVIDIA_VISIBLE_DEVICES=all 
      - DISPLAY=$DISPLAY
      - QT_X11_NO_MITSHM=1
      - XAUTHORITY=/tmp/xauth/.docker.xauth     
    devices:
      - /dev/dri:/dev/dri
      - /dev/snd:/dev/snd
    command: bash -c "source /workspace/install/setup.bash && ros2 launch face_recognition face_recognition.launch.py compressed_topic:=${IMG_RAW_TOPIC:-/camera/image_raw/compressed}"
    stop_signal: SIGINT
    stop_grace_period: 30s

  eut_gaze_estimation:
    container_name: "eut_gaze_estimation"
    network_mode: host 
    ipc: host
    shm_size: 1gb
    runtime: ${DOCKER_RUNTIME:-runc}
    image: ${BUILT_IMAGE}
    privileged: true
    depends_on:
      - mongodb_faces_service
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ~/.xauth_docker/share/:/tmp/xauth/
      - ./.vscode:/workspace/.vscode
      - ../face_detection:/workspace/src/face_detection
      - ../face_recognition:/workspace/src/face_recognition
      - ../gaze_estimation:/workspace/src/gaze_estimation
      - ../visual_speech_activity:/workspace/src/visual_speech_activity
      # Cyclone DDS configuration for TiagoPro WiFi
      - ./cyclonedds_wifi.xml:/etc/cyclonedds.xml:ro
      - ./logs:/workspace/log

    tty: true
    stdin_open: true
    environment:
      - CYCLONEDDS_URI=file:///etc/cyclonedds.xml
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-0}  
      - RMW_IMPLEMENTATION=${RMW_IMPLEMENTATION:-rmw_fastdds_cpp}   
      - PACKAGE_NAME=gaze_estimation
      - NVIDIA_VISIBLE_DEVICES=all 
      - DISPLAY=$DISPLAY
      - QT_X11_NO_MITSHM=1
      - XAUTHORITY=/tmp/xauth/.docker.xauth     
    devices:
      - /dev/dri:/dev/dri
      - /dev/snd:/dev/snd
    command: bash -c "source /workspace/install/setup.bash && ros2 launch gaze_estimation gaze_estimation.launch.py compressed_topic:=${IMG_RAW_TOPIC:-/camera/image_raw/compressed}"
    stop_signal: SIGINT
    stop_grace_period: 30s

  eut_visual_speech_activity:
    container_name: "eut_visual_speech_activity"
    network_mode: host 
    ipc: host
    shm_size: 1gb
    runtime: ${DOCKER_RUNTIME:-runc}
    image: ${BUILT_IMAGE}
    privileged: true
    depends_on:
      - mongodb_faces_service
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ~/.xauth_docker/share/:/tmp/xauth/
      - ./.vscode:/workspace/.vscode
      - ../face_detection:/workspace/src/face_detection
      - ../face_recognition:/workspace/src/face_recognition
      - ../gaze_estimation:/workspace/src/gaze_estimation
      - ../visual_speech_activity:/workspace/src/visual_speech_activity
      - ./logs:/workspace/log
      # Cyclone DDS configuration for TiagoPro WiFi
      - ./cyclonedds_wifi.xml:/etc/cyclonedds.xml:ro
    tty: true
    stdin_open: true
    environment:
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-0}    
      - NVIDIA_VISIBLE_DEVICES=all 
      - PACKAGE_NAME=visual_speech_activity
      - DISPLAY=$DISPLAY
      - QT_X11_NO_MITSHM=1
      - XAUTHORITY=/tmp/xauth/.docker.xauth     
    devices:
      - /dev/dri:/dev/dri
      - /dev/snd:/dev/snd
    command: bash -c "source /workspace/install/setup.bash && ros2 launch visual_speech_activity visual_speech_activity.launch.py compressed_topic:=/camera/image_raw/compressed"
    stop_signal: SIGINT
    stop_grace_period: 30s

  mongodb_faces_service:
    image: mongo:7
    container_name: "mongodb_faces"
    restart: unless-stopped
    ports:
      - "27018:27017" 
    volumes:
      - mongodb_faces_data:/data/db
    environment:
      - MONGODB_INITDB_ROOT_USERNAME=eurecat
      - MONGODB_INITDB_ROOT_PASSWORD=cerdanyola
    stop_signal: SIGTERM
    stop_grace_period: 60s
    #if any change in env vars, need to delete volume coghri_faces_mongodb_data to reinit DB
    #docker compose down -v

  mongo_express_faces:
    image: mongo-express:latest
    container_name: "mongo-express-faces"
    restart: unless-stopped
    depends_on:
      - mongodb_faces_service
    ports:
      - "8082:8081"  
    environment:
      - ME_CONFIG_MONGODB_ENABLE_ADMIN=true
      - ME_CONFIG_MONGODB_ADMINUSERNAME=eurecat
      - ME_CONFIG_MONGODB_ADMINPASSWORD=cerdanyola
      - ME_CONFIG_MONGODB_SERVER=mongodb_faces_service
      - ME_CONFIG_MONGODB_URL=mongodb://eurecat:cerdanyola@mongodb_faces_service:27017/?authSource=admin

volumes:
  mongodb_faces_data:
    name: coghri_faces_mongodb_data
    driver: local

